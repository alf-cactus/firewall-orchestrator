# database documentation for developers

## modularization/encapsulation
Only the API has direct access to the database. 
All access to the database must go though the API utilising the RBAC model implemented in the API.

This goes for 
- UI access
- middleware server access
- and of course direct API access 

Also no (permission-based) filtering should be done anywhere but within the API to make sure permissions are enforced equally no matter if the data access goes via UI or directly via API.

## Technology
### DMBS
Postgresql server. Currently supported are v9-14. We are using the default version provided by the operating system

### API
Hasura graphql API - always using the latest stable release, currently v2.7.0 (June 2022).
We are using HASURA_GRAPHQL_V1_BOOLEAN_NULL_COLLAPSE=True to make the graphql API v2.x backward compatible with v1.0 (null result in where clause means true). Default settings "false" breaks query functionality. This might have to be migrated later to ensure new standard logic. See <https://hasura.io/docs/latest/graphql/core/guides/upgrade-hasura-v2.html#what-has-changed>.

### Authentication & Authorization

Is handled via JWT mechanism.

## Content - network-technical description
The purpose of the whole product is to read configuration data of firewall systems, normalize these and provide a unified view to be able to handle all processes around firewall management independant of the actual firewall brands used.

Currently this is implemented for the classical firewall gateway system from vendors like Check Point, Fortinet, Barracuda and Juniper.
We are planning to include SDN (software defined networking)-based  systems from vendors Cisco and VMware in 2023ff and are also looking on more generic approaches to handle all sorts of configuration rules like proxy, loadbancer configurations starting with the use case "recertication". 

The configuration of the firewalls is stored over time allowing to e.g. list a rulebase at a specific time or changes in specific rules over time.

### Definitions - wording

- Device - generic term for all sorts of network systems like security gateways, firewalls and firewall management systems
- Gateway - a classic network security gateway, aka firewall gateway
- Rule - a single access rule enforced on a gateway 
- Rulebase - a list of rules which are checked by the firewall in a specific order to decide on whether traffic is allowed.
- Network object - network object used in a rule as source or destination - can be a single host, range, network or group of the previous classes
- Service - here a network service - usually a combination of protocol (e.g. tcp) and port (e.g. 22), can also be a port range or group.
- User - a user used within a rule not to be confused with other users (e.g. logging in to the UI). Might be a single user or a group.
- Zone - a network zone that is used (in some firewall systems) to separate the network into different parts. Normally a gateway interface belongs to a specific zone.
- access request / ticket - a request sent by a requester to apply for access resulting in the adding of one or more rules to the firewall(s). This request can contain multiple tasks.
- request task - part of an access request - e.g. a single access request. 

## Permission handling
### API - DB interacton
### RBAC (API permissions)
#### Roles

## DB structure

[Entity relationship diagram](https://github.com/CactuseSecurity/firewall-orchestrator/wiki/Database-structure)

generated by [DbVisualizer](https://dbvis.com/) - [Download](https://dbvis.com/product_download/dbvis-13.0.4/media/dbvis_linux_13_0_4.sh)

### Schema public
#### Firewall configuration data tables and relations
All the following tables belong to the "public" schema which is not explicitly listed here.
- Device - device + management (a device is always linked to a management)
- Gateway - device
- Rule - rule, rule_metadata (linked by a rule UID)- the rule table contains a snapshot of a rule in time, rule_ metadata contains more static information which refers to the rule during its whole lifetime, not just the snapshot
- Rulebase - no separate table but certain entries in the rule table identified by belonging to a specific gateway 
- Network object - object
- Service - service
- User - usr 
- Zone - zone

### Schema request (in development)
#### Request data
- access request / ticket - request.ticket
- request task - request.task

### Schema implementation (in development)
### Schema atomized (in development)

## Processes involving DB access

### Import
#### Legacy import
There are still some import modules (e.g. for Barracuda, Juniper) written in perl which 
connect to the firewall systems via ssh and write the normalized data directly to the database without using the API.

#### API Import
The standard way to import data from firewalls is via their respective (REST) API.
The FWORCH import module normalizes the data and passes it to the FWORCH (GraphQL) API.

##### Interface for importers
see https://github.com/CactuseSecurity/firewall-orchestrator/blob/main/documentation/developer-docs/importer/FWO-import-api.md


### Reporting

### Recertification

### Request module (in development)

### UI localization (multi-language UI)

We are using a multi-language UI. All texts are contained in roles/database/files/sql/idempotent/fworch-texts.sql and will be re-loaded with each upgrade.

#### Adding new languages
New languages can be activated by simply adding the value in roles/database/files/sql/creation/fworch-fill-stm.sql as follows:

    INSERT INTO language ("name", "culture_info") VALUES('English', 'en-US');


### Storage of FWORCH configuration data

## Database optimization
See issue https://github.com/CactuseSecurity/firewall-orchestrator/issues/1509

### Using indices
- Identify frequent access to the database (good starting point is the roles/lib/files/FWO.Api.Client directory) and add index if not already primary key
- Remove existing unnecessary indices

### Temporary Tables
- make sure temporary tables do not grow (e.g. import_object/service/...)

### Watch large tables
### Avoid complex stored proceures
### Debug timing granularly to identify bottle-necks

## Div open DB issues
### Missing normalizations
see https://github.com/CactuseSecurity/firewall-orchestrator/issues/839

- normalize rule action (allow/deny/reject/...)
- normalize rule tracking (log/account/nil/...)
- any objects (any - remove All/ALL/all), might also add none object
